<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#1a73e8">
  <meta name="description" content="Hostizzy Guest Portal v2 ‚Äî secure KYC & meal selection after approval">
  <title>Hostizzy Guest Portal v2</title>

  <!-- PWA Manifest & Icons (optional) -->
  <link rel="manifest" href="guest-manifest.json">
  <link rel="icon" type="image/png" href="assets/logo-192.png">
  <link rel="apple-touch-icon" href="assets/logo-192.png">

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --primary:#1a73e8;
      --primary-dark:#1557b0;
      --primary-50:#e8f0fe;
      --success:#34a853;
      --warning:#fbbc04;
      --danger:#ea4335;
      --ink:#202124;
      --muted:#5f6368;
      --border:#dadce0;
      --bg:#fff;
      --bg-2:#f8f9fa;
      --radius:14px;
      --shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);
      --shadow-lg:0 8px 24px rgba(0,0,0,.18);
      --ease:all .25s ease;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu; background:var(--bg-2); color:var(--ink); -webkit-font-smoothing:antialiased}
    .app{max-width:640px;margin:0 auto;min-height:100vh;background:var(--bg);box-shadow:var(--shadow)}
    header{position:sticky;top:0;z-index:10;background:var(--primary);color:#fff;padding:18px 20px;box-shadow:var(--shadow)}
    header h1{font-size:20px;font-weight:700;display:flex;gap:8px;align-items:center;justify-content:center}
    header .sub{opacity:.95;font-size:13px;text-align:center;margin-top:4px}
    main{padding:18px}
    .screen{display:none;animation:fade .25s ease}
    .screen.active{display:block}
    @keyframes fade{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
    .card{background:#fff;border-radius:var(--radius);padding:18px;margin-bottom:16px;box-shadow:var(--shadow)}
    .card .h{display:flex;gap:10px;align-items:center;border-bottom:1px solid var(--bg-2);padding-bottom:10px;margin-bottom:12px}
    .card .h h2{font-size:16px;font-weight:700}
    .muted{color:var(--muted);font-size:14px}
    label{display:block;font-size:14px;font-weight:600;margin-bottom:6px}
    input, select{width:100%;border:2px solid var(--border);border-radius:10px;padding:12px 14px;font-size:16px;transition:var(--ease);background:#fff}
    input:focus, select:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px var(--primary-50)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .btn{display:inline-flex;gap:8px;align-items:center;justify-content:center;border:none;border-radius:10px;padding:13px 18px;font-weight:700;font-size:16px;cursor:pointer;transition:transform .08s ease, background .2s ease}
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:var(--primary);color:#fff}
    .btn.secondary{background:var(--bg-2);color:var(--ink)}
    .btn.success{background:var(--success);color:#fff}
    .btn.block{width:100%}
    .badge{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:800;text-transform:uppercase}
    .b-pending{background:var(--warning);color:#000}
    .b-verified{background:var(--success);color:#fff}
    .b-rejected{background:var(--danger);color:#fff}
    .b-incomplete{background:var(--muted);color:#fff}
    .pulse{animation:pulse 1.2s infinite}
    @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.03)}100%{transform:scale(1)}}
    .list{display:flex;flex-direction:column;gap:12px}
    .item{background:var(--bg-2);border-radius:12px;padding:14px;display:flex;align-items:center;justify-content:space-between;cursor:pointer;border:2px solid transparent;transition:var(--ease)}
    .item:hover{border-color:var(--border);background:#fff}
    .status{margin-left:10px}
    .progress{height:8px;background:var(--bg-2);border-radius:6px;overflow:hidden;margin:10px 0}
    .fill{height:100%;background:var(--primary);width:0;transition:width .3s ease}
    .center{text-align:center}
    .help{background:var(--primary-50);color:var(--primary-dark);border-left:4px solid var(--primary);padding:12px;border-radius:10px;margin:10px 0}
    .warn{background:#fef7e0;color:#7f5f01;border-left:4px solid var(--warning);padding:12px;border-radius:10px;margin:10px 0}
    .success{background:#e6f4ea;color:#137333;border-left:4px solid var(--success);padding:12px;border-radius:10px;margin:10px 0}
    .toolbar{display:flex;gap:10px;margin-top:10px}
    .top-progress{font-size:13px;color:var(--muted);margin-bottom:10px}
    .hidden{display:none!important}
    footer{padding:24px;text-align:center;color:var(--muted);font-size:14px;border-top:1px solid var(--border);margin-top:24px}
    @media(max-width:480px){main{padding:14px}.row{grid-template-columns:1fr}}
    @keyframes slideIn{from{transform:translateX(400px);opacity:0}to{transform:translateX(0);opacity:1}}
    @keyframes slideOut{from{transform:translateX(0);opacity:1}to{transform:translateX(400px);opacity:0}}
  </style>
</head>
<body>
<div class="app">
  <header>
    <h1>üè† Hostizzy Guest Portal v2</h1>
    <div class="sub">Secure KYC ‚Ä¢ Real‚Äëtime status ‚Ä¢ Meal selection after approval</div>
  </header>

  <main>
    <!-- SCREEN 1: VERIFY (Booking Code + Phone) -->
    <section id="scrVerify" class="screen active">
      <div class="card">
        <div class="h"><span>üîê</span><h2>Verify your booking</h2></div>
        <p class="muted">Use your booking code and your phone number. The link is universal ‚Äî no details in the URL.</p>
        <form id="formVerify">
          <label for="bookingId">Booking Code</label>
          <input id="bookingId" placeholder="e.g., HZ-AB12CD" required autocomplete="off">
          <label for="phone" style="margin-top:10px">Phone Number</label>
          <input id="phone" type="tel" inputmode="numeric" pattern="[0-9]{10}" placeholder="10-digit mobile" required autocomplete="tel">
          <div class="toolbar">
            <button class="btn primary block" type="submit">Continue ‚Üí</button>
          </div>
        </form>
      </div>
      <div class="help">Having trouble? Reach out to your Hostizzy coordinator with your booking code.</div>
    </section>

    <!-- SCREEN 2: ENTER GUEST NAMES (Primary only) -->
    <section id="scrNames" class="screen">
      <div class="card">
        <div class="h"><span>üìù</span><h2>Enter all guest names</h2></div>
        <p class="muted">Add names for every adult guest. You can edit later if needed.</p>
        <div id="namesContainer" class="list"></div>
        <div class="toolbar">
          <button id="btnSaveNames" class="btn primary block">Save & Continue</button>
        </div>
      </div>
    </section>

    <!-- SCREEN 3: DASHBOARD -->
    <section id="scrDash" class="screen">
      <div class="card">
        <div class="h"><span>üè°</span><h2 id="propTitle">Reservation</h2></div>
        <div class="row">
          <div>
            <label>Check‚Äëin</label>
            <div id="ci" class="muted">‚Äî</div>
          </div>
          <div>
            <label>Check‚Äëout</label>
            <div id="co" class="muted">‚Äî</div>
          </div>
          <div>
            <label>Nights</label>
            <div id="nights" class="muted">‚Äî</div>
          </div>
          <div>
            <label>Guests</label>
            <div id="guests" class="muted">‚Äî</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="h"><span>üí∞</span><h2>Payment Details</h2></div>
        <div class="row">
          <div>
            <label>Total Amount</label>
            <div id="totalAmount" class="muted">‚Çπ‚Äî</div>
          </div>
          <div>
            <label>Payment Status</label>
            <div id="paymentStatus" class="muted">‚Äî</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="h"><span>üìÑ</span><h2>Guest KYC</h2></div>
        <div class="top-progress" id="topStepText">Guest 1/1 ‚Äî Step 1/4</div>
        <div class="progress"><div id="bar" class="fill" style="width:0%"></div></div>
        <div id="listGuests" class="list"></div>
        <div class="warn">Data is auto‚Äëdeleted 60 days after check‚Äëout. Phone & email are used only for operational updates.</div>
        <div class="toolbar">
          <button id="btnLogout" class="btn secondary block">Logout</button>
        </div>
      </div>

       <div class="card hidden" id="mealsCard">
        <div class="h"><span>üçΩÔ∏è</span><h2>Meals</h2></div>
        <div class="success">All guests are verified. You can now select meals for your group.</div>
        <button id="btnMeals" class="btn success block">Proceed to Meal Selection ‚Üí</button>
      </div>
    </section>

    <!-- SCREEN 5: MEAL SELECTION (Primary guest only) -->
    <section id="scrMeals" class="screen">
      <div class="card">
        <div class="h"><span>üçΩÔ∏è</span><h2>Select Meals for Your Group</h2></div>
        <p class="muted">As primary guest, select meals for all guests. Dietary preferences & special requests are optional.</p>
      </div>

      <div id="mealsContainer" class="list"></div>

      <div class="card">
        <label for="dietaryPref">Dietary Preferences (Optional)</label>
        <input id="dietaryPref" placeholder="e.g., Vegetarian, Vegan, Gluten-free, etc.">
        <label for="specialReq" style="margin-top:10px">Special Requests (Optional)</label>
        <input id="specialReq" placeholder="e.g., Extra spice, No onions, etc.">
        <div class="toolbar" style="margin-top:14px">
          <button id="btnSaveMeals" class="btn success block">Save Meal Selections</button>
          <button id="btnCancelMeals" class="btn secondary block" style="margin-top:8px">Back to Dashboard</button>
        </div>
      </div>
    </section>

    <!-- SCREEN 4: GUEST FORM (Primary: selfie required; Additional: no selfie) -->
    <section id="scrForm" class="screen">
      <div class="card">
        <div class="h"><span>üë§</span><h2 id="formTitle">Guest Information</h2></div>
        <div id="stepText" class="top-progress">Guest 1/1 ‚Äî Step 2/4</div>
        <form id="formGuest">
          <label for="gName">Full name (as per ID)</label>
          <input id="gName" required placeholder="Enter full name">

          <div class="row" style="margin-top:10px">
            <div>
              <label for="gAge">Age</label>
              <input id="gAge" type="number" min="1" max="120" required placeholder="18">
            </div>
            <div>
              <label for="gEmail">Email</label>
              <input id="gEmail" type="email" required placeholder="name@email.com">
            </div>
          </div>

          <label for="gPhone" style="margin-top:10px">Phone</label>
          <input id="gPhone" type="tel" inputmode="numeric" pattern="[0-9]{10}" required placeholder="10-digit mobile">

          <div id="idBlock">
            <label style="margin-top:10px">ID Type</label>
            <select id="idType" required>
              <option value="" disabled selected>Select one</option>
              <option value="aadhar">Aadhar Card</option>
              <option value="passport">Passport</option>
              <option value="driving_license">Driver's License</option>
              <option value="voter_id">Voter ID</option>
            </select>

            <label for="idNumber" style="margin-top:10px">ID Number</label>
            <input id="idNumber" placeholder="Enter ID number">

            <div style="margin-top:10px">
              <label>Document ‚Äî Front</label>
              <input id="fileFront" type="file" accept="image/*" capture="environment" required>
            </div>
            <div id="backWrap" style="margin-top:10px">
              <label>Document ‚Äî Back</label>
              <input id="fileBack" type="file" accept="image/*" capture="environment">
            </div>
            <div id="selfieWrap" style="margin-top:10px">
              <label>Live Selfie (primary guest only)</label>
              <input id="fileSelfie" type="file" accept="image/*" capture="user">
            </div>
          </div>

          <div class="toolbar" style="margin-top:12px">
            <button id="btnCancelForm" type="button" class="btn secondary">Cancel</button>
            <button class="btn primary" type="submit">Save & Submit</button>
          </div>
        </form>
      </div>
    </section>

    <!-- SUCCESS MINI -->
    <section id="scrDone" class="screen">
      <div class="card center">
        <div style="font-size:64px;margin-bottom:12px">‚úÖ</div>
        <h2>Submission successful</h2>
        <p class="muted" style="margin-top:6px">We‚Äôll review and update the status shortly.</p>
        <div class="success" style="margin-top:12px">You‚Äôll also get an email when verification is completed.</div>
        <button id="btnBackDash" class="btn primary block" style="margin-top:14px">Back to Dashboard</button>
      </div>
    </section>
  </main>

  <footer>¬© 2025 Hostizzy. All rights reserved.</footer>
</div>

<!-- Loading overlay -->
<div id="overlay" style="position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:9999;">
  <div style="text-align:center;color:#fff">
    <div style="width:54px;height:54px;border-radius:50%;border:4px solid rgba(255,255,255,.35);border-top-color:#fff;animation:spin 1s linear infinite;margin:0 auto"></div>
    <div id="ovText" style="margin-top:10px;font-weight:600">Loading...</div>
  </div>
</div>
<style>@keyframes spin{to{transform:rotate(360deg)}}</style>

<script>
/* ---------- CONFIG ---------- */
const SUPABASE_URL = 'https://dxthxsguqrxpurorpokq.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR4dGh4c2d1cXJ4cHVyb3Jwb2txIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwMjc4MTMsImV4cCI6MjA3NTYwMzgxM30.JhGzqUolA-A_fGha-0DhHVl7p1vRq4CZcp5ttdVxjQg';

const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ---------- APP STATE ---------- */
const S = {
  reservation: null,
  isPrimary: false,
  session: null,
  docs: [],
  mealPrefs: {},
  pollTimer: null,
  currentSeq: null,
  totalAdults: 0,
  menuData: null
};

/* ---------- HELPERS ---------- */
const q = sel => document.querySelector(sel);
const show = id => { document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); q('#'+id).classList.add('active'); };
const loadOn = (msg='Loading...') => { q('#ovText').textContent = msg; q('#overlay').style.display='flex'; };
const loadOff = () => { q('#overlay').style.display='none'; };

const fmtDate = d => new Date(d).toLocaleDateString('en-IN',{day:'numeric',month:'short',year:'numeric'});
const randToken = () => crypto.getRandomValues(new Uint8Array(16)).reduce((a,b)=>a+('0'+b.toString(16)).slice(-2),'');

/* ---------- SESSION (24h) ---------- */
const SESSION_KEY = 'hz_guest_session_v2';
function saveSessionLocally(obj){
  const payload = {...obj, expiresAt: Date.now() + 24*60*60*1000};
  localStorage.setItem(SESSION_KEY, JSON.stringify(payload));
}
function readSessionLocally(){
  const raw = localStorage.getItem(SESSION_KEY);
  if(!raw) return null;
  const data = JSON.parse(raw);
  if(Date.now()>data.expiresAt){ localStorage.removeItem(SESSION_KEY); return null; }
  return data;
}

/* ---------- LOAD MENU ---------- */
async function loadMenuData(){
  try{
    const res = await fetch('/menu-template-standard.json');
    S.menuData = await res.json();
  }catch(e){ console.error('Menu load failed:', e); }
}

/* ---------- GENERATE WHATSAPP LINK ---------- */
function generateWhatsAppLink(phone, message){
  const encoded = encodeURIComponent(message);
  return `https://wa.me/${phone}?text=${encoded}`;
}

/* ---------- WHATSAPP INTEGRATION ---------- */
function sendWhatsAppReminder(phone, bookingCode){
  const message = `üëã Hi! Please complete your KYC verification for booking ${bookingCode}. Visit: resiq.hostizzy.com/guest-portal.html`;
  const link = generateWhatsAppLink(phone, message);
  window.open(link, '_blank');
}

function sendWhatsAppApprovalNotification(phone, propertyName){
  const message = `‚úÖ Great news! Your KYC is approved for ${propertyName}. You can now select meals for your stay. Visit: resiq.hostizzy.com/guest-portal.html`;
  const link = generateWhatsAppLink(phone, message);
  window.open(link, '_blank');
}

function generateWhatsAppLink(phone, message){
  const cleanPhone = phone.replace(/\\D/g,'');
  const countryCode = cleanPhone.length === 10 ? '91' : '';
  const encoded = encodeURIComponent(message);
  return `https://wa.me/${countryCode}${cleanPhone}?text=${encoded}`;
}

/* ---------- VERIFY ---------- */
q('#formVerify').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const booking_id = q('#bookingId').value.trim().toUpperCase();
  const phone = q('#phone').value.trim();

  loadOn('Verifying booking...');
  try{
    const { data: rsv, error } = await client.from('reservations').select('*').eq('booking_id', booking_id).single();
    if(error || !rsv){ loadOff(); alert('Booking not found. Check your code.'); return; }
    if(rsv.status === 'cancelled'){ loadOff(); alert('This reservation is cancelled.'); return; }

    S.reservation = rsv;
    S.totalAdults = rsv.adults || 1;
    S.isPrimary = phone.replace(/\\D/g,'').slice(-10) === (rsv.guest_phone||'').replace(/\\D/g,'').slice(-10);

    // Create/record a session row
    const token = randToken();
    await client.from('guest_portal_sessions').insert({
      booking_id,
      guest_sequence: null,
      phone_verified: true, // Using booking+phone gate
      verified_at: new Date().toISOString(),
      session_token: token,
      guest_names_entered: false
    });

    S.session = { booking_id, token, phone };
    saveSessionLocally(S.session);

    // Send WhatsApp reminder if primary guest (24h reminder)
    if(S.isPrimary){
      const checkInTime = new Date(rsv.check_in).getTime();
      const hoursUntilCheckIn = (checkInTime - Date.now()) / (1000 * 60 * 60);
      if(hoursUntilCheckIn <= 24 && hoursUntilCheckIn > 0){
        setTimeout(() => {
          const confirm = window.confirm('üì± Send KYC reminder via WhatsApp?');
          if(confirm) sendWhatsAppReminder(phone, booking_id);
        }, 500);
      }
    }

    // Ensure initial guest name rows exist or ask primary to enter
    await ensureNameRowsOrCollect();

  }catch(err){
    console.error(err); alert('Error during verification. Try again.');
  }finally{ loadOff(); }
});

/* ---------- Ensure guest name rows ---------- */
async function ensureNameRowsOrCollect(){
  // Load docs to see if rows exist
  await loadDocs();

  const haveRows = S.docs.length > 0;
  const namesMissing = S.docs.length < S.totalAdults || S.docs.some(d=>!d.guest_name);

  if(S.isPrimary && (!haveRows || namesMissing)){
    // Primary must fill names
    renderNamesInputs();
    show('scrNames');
  }else{
    // Go to dashboard
    await showDashboard();
  }
}

function renderNamesInputs(){
  const box = q('#namesContainer'); box.innerHTML='';
  const count = Math.max(S.totalAdults, S.docs.length || 0);
  for(let i=1;i<=count;i++){
    const existing = S.docs.find(d=>d.guest_sequence===i);
    const val = existing?.guest_name || (i===1 ? S.reservation.guest_name : `Guest ${i}`);
    const row = document.createElement('div');
    row.className='item';
    row.innerHTML = `
      <div style="flex:1">
        <div class="muted">Guest ${i}${i===1?' (Primary)':''}</div>
        <input data-seq="${i}" class="nameInput" style="margin-top:6px" value="${val}">
      </div>`;
    box.appendChild(row);
  }
}

q('#btnSaveNames').addEventListener('click', async ()=>{
  loadOn('Saving names...');
  try{
    const inputs = Array.from(document.querySelectorAll('.nameInput'));
    for(const inp of inputs){
      const seq = parseInt(inp.getAttribute('data-seq'));
      const name = inp.value.trim();
      if(!name) continue;
      // upsert minimal guest_documents row as 'incomplete'
      const { data: existing } = await client
         .from('guest_documents')
         .select('id')
         .eq('booking_id', S.reservation.booking_id)
         .eq('guest_sequence', seq)
         .maybeSingle();

      const payload = {
        booking_id: S.reservation.booking_id,
        guest_type: seq===1 ? 'primary' : 'additional',
        guest_sequence: seq,
        guest_name: name,
        status: 'incomplete' // placeholder until they upload docs
      };

      if(existing){ await client.from('guest_documents').update(payload).eq('id', existing.id); }
      else{ await client.from('guest_documents').insert(payload); }
    }

    // Mark session flag
    await client.from('guest_portal_sessions')
      .update({ guest_names_entered: true })
      .eq('session_token', S.session.token);

    await loadDocs();
    await showDashboard();
  }catch(e){ console.error(e); alert('Could not save names.'); }
  finally{ loadOff(); }
});

/* ---------- LOAD DOCS & POLL ---------- */
async function loadDocs(){
  const { data, error } = await client
    .from('guest_documents')
    .select('*')
    .eq('booking_id', S.reservation.booking_id)
    .order('guest_sequence', { ascending:true });
  if(!error && data){ S.docs = data; }
}

async function loadMealPrefs(){
  const { data, error } = await client
    .from('guest_meal_preferences')
    .select('*')
    .eq('booking_id', S.reservation.booking_id);
  if(!error && data){
    S.mealPrefs = {};
    data.forEach(pref => {
      const key = `${pref.guest_sequence}_${pref.meal_type}`;
      S.mealPrefs[key] = pref;
    });
  }
}

async function setupApprovalListener(){
  // Subscribe to guest_documents changes for this booking
  const subscription = client
    .channel(`doc_changes_${S.reservation.booking_id}`)
    .on(
      'postgres_changes',
      {
        event: 'UPDATE',
        schema: 'public',
        table: 'guest_documents',
        filter: `booking_id=eq.${S.reservation.booking_id}`
      },
      async (payload) => {
        const newData = payload.new;
        const oldData = payload.old;
        
        // Status changed to verified
        if(oldData?.status !== 'verified' && newData?.status === 'verified'){
          await loadDocs();
          renderDashGuests();
          updateDashProgress();
          maybeShowMeals();
          
          // Show approval notification
          showApprovalNotification(newData.guest_name, S.reservation.property_name);
          
          // If primary guest approved, send WhatsApp
          if(newData.guest_sequence === 1 && S.isPrimary){
            const sendViaWA = confirm(`‚úÖ KYC approved! Send confirmation via WhatsApp to ${S.reservation.guest_phone}?`);
            if(sendViaWA){
              sendWhatsAppApprovalNotification(S.reservation.guest_phone, S.reservation.property_name);
            }
          }
        }
      }
    )
    .subscribe();
    
  S.approvalSubscription = subscription;
}

function showApprovalNotification(guestName, propertyName){
  const notif = document.createElement('div');
  notif.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: var(--success);
    color: white;
    padding: 16px 20px;
    border-radius: 10px;
    box-shadow: var(--shadow-lg);
    z-index: 10000;
    font-weight: 600;
    animation: slideIn 0.3s ease;
  `;
  notif.textContent = `‚úÖ ${guestName}'s KYC approved for ${propertyName}`;
  document.body.appendChild(notif);
  
  setTimeout(() => {
    notif.style.animation = 'slideOut 0.3s ease';
    setTimeout(() => notif.remove(), 300);
  }, 4000);
}

function startPolling(){
  stopPolling();
  S.pollTimer = setInterval(async ()=>{
    const onDash = q('#scrDash').classList.contains('active');
    if(!onDash) return;
    await loadDocs();
    await loadMealPrefs();
    renderDashGuests();
    updateDashProgress();
    maybeShowMeals();
  }, 3000);
}
function stopPolling(){ if(S.pollTimer){ clearInterval(S.pollTimer); S.pollTimer=null; }}

/* ---------- DASHBOARD ---------- */
async function showDashboard(){
  // fill rsv details
  const r = S.reservation;
  q('#propTitle').textContent = r.property_name || 'Reservation';
  q('#ci').textContent = fmtDate(r.check_in);
  q('#co').textContent = fmtDate(r.check_out);
  q('#nights').textContent = (r.nights || 1) + ' night' + ((r.nights||1)>1?'s':'');
  q('#guests').textContent = `${r.adults||1} adults${r.kids?`, ${r.kids} kids`:''}`;

  // Payment details
  q('#totalAmount').textContent = r.total_amount ? `‚Çπ${parseFloat(r.total_amount).toLocaleString('en-IN')}` : '‚Çπ‚Äî';
  const payStatus = r.payment_status || 'pending';
  const payStatusText = payStatus === 'paid' ? '‚úÖ Paid' : payStatus === 'pending' ? '‚è≥ Pending' : '‚ùå Failed';
  q('#paymentStatus').textContent = payStatusText;

  renderDashGuests();
  updateDashProgress();
  maybeShowMeals();

  show('scrDash');
  await setupApprovalListener();
  startPolling();
}

function renderDashGuests(){
  const list = q('#listGuests'); list.innerHTML='';
  const total = S.totalAdults || Math.max(1, S.docs.length);
  for(let i=1;i<=total;i++){
    const doc = S.docs.find(d=>d.guest_sequence===i);
    const name = doc?.guest_name || (i===1? (S.reservation.guest_name||'Primary Guest') : `Guest ${i}`);
    const status = doc?.status || 'incomplete';

    const badge =
      status==='verified' ? '<span class="badge b-verified">Verified</span>' :
      status==='pending' ? '<span class="badge b-pending pulse">Pending</span>' :
      status==='rejected' ? '<span class="badge b-rejected">Rejected</span>' :
      '<span class="badge b-incomplete">Incomplete</span>';

    const item = document.createElement('div');
    item.className='item';
    item.innerHTML = `
      <div>
        <div style="font-weight:700">${name}${i===1?' (Primary)':''}</div>
        <div class="muted">Guest ${i}</div>
      </div>
      <div class="status">${badge}</div>`;

    item.addEventListener('click', ()=> openGuestForm(i));
    list.appendChild(item);
  }
}

function updateDashProgress(){
  const total = Math.max(S.totalAdults, S.docs.length||0) || 1;
  const verified = (S.docs||[]).filter(d=>d.status==='verified').length;
  q('#bar').style.width = `${(verified/total)*100}%`;
  q('#topStepText').textContent = `Guest ${Math.min((S.currentSeq||1), total)}/${total} ‚Äî Step ${S.isPrimary?2:2}/4`;
}

function maybeShowMeals(){
  const total = Math.max(S.totalAdults, S.docs.length||0) || 1;
  const verified = (S.docs||[]).filter(d=>d.status==='verified').length;
  q('#mealsCard').classList.toggle('hidden', verified < total);
}

/* ---------- OPEN GUEST FORM ---------- */
function openGuestForm(seq){
  stopPolling();
  S.currentSeq = seq;
  const isPrimary = seq===1;
  const doc = S.docs.find(d=>d.guest_sequence===seq);

  q('#formTitle').textContent = isPrimary ? 'Primary Guest ‚Äî KYC' : `Guest ${seq} ‚Äî KYC`;
  q('#stepText').textContent = `Guest ${seq}/${Math.max(S.totalAdults,S.docs.length||0)||1} ‚Äî Step 2/4`;

  // Prefill
  q('#gName').value = doc?.guest_name || (isPrimary ? (S.reservation.guest_name||'') : `Guest ${seq}`);
  q('#gAge').value = doc?.guest_age || '';
  q('#gEmail').value = doc?.guest_email || (isPrimary ? (S.reservation.guest_email || '') : '');
  q('#gPhone').value = doc?.guest_phone || (isPrimary ? (S.reservation.guest_phone || '') : '');
  q('#idType').value = doc?.document_type || '';
  q('#idNumber').value = doc?.document_number || '';

  // Selfie only for primary
  q('#selfieWrap').style.display = isPrimary ? 'block' : 'none';

  // Back required for certain IDs
  const needsBack = ['aadhar','driving_license','voter_id'].includes(q('#idType').value);
  q('#backWrap').style.display = needsBack ? 'block' : 'none';

  show('scrForm');
}

/* Toggle back field when ID type changes */
q('#idType').addEventListener('change', ()=>{
  const v = q('#idType').value;
  q('#backWrap').style.display = (['aadhar','driving_license','voter_id'].includes(v)) ? 'block' : 'none';
});

/* ---------- SUBMIT GUEST FORM ---------- */
q('#formGuest').addEventListener('submit', async (e)=>{
  e.preventDefault();

  // Basic validation (email & phone required for ALL)
  const name = q('#gName').value.trim();
  const age  = parseInt(q('#gAge').value,10);
  const email= q('#gEmail').value.trim();
  const phone= q('#gPhone').value.trim();

  if(!name){ alert('Enter full name'); return; }
  if(!email){ alert('Enter email'); return; }
  if(!/^[0-9]{10}$/.test(phone)){ alert('Enter a valid 10‚Äëdigit phone'); return; }

  const isMinor = age < 18;
  const seq = S.currentSeq;
  const isPrimary = seq===1;

  // Collect ID fields (minors skip uploads and are auto‚Äëverified)
  let idType=null,idNumber=null,front=null,back=null,selfie=null;
  if(!isMinor){
    idType = q('#idType').value;
    idNumber = q('#idNumber').value.trim();
    if(!idType){ alert('Select an ID type'); return; }
    if(!q('#fileFront').files[0]){ alert('Upload front side of the ID'); return; }
    const needBack = ['aadhar','driving_license','voter_id'].includes(idType);
    if(needBack && !q('#fileBack').files[0]){ alert('Upload back side of the ID'); return; }
    if(isPrimary && !q('#fileSelfie').files[0]){ alert('Primary guest must add a selfie'); return; }

    front = q('#fileFront').files[0];
    back  = q('#fileBack').files[0] || null;
    selfie= q('#fileSelfie').files[0] || null;
  }

  loadOn('Uploading documents...');

  try{
    // Uploads to storage (if adult)
    let front_url=null, back_url=null, selfie_url=null;
    const folder = `${S.reservation.booking_id}/guest_${seq}_${name.replace(/\\s+/g,'_').toLowerCase()}`;
    const ts = Date.now();

    async function upload(name, file){
      if(!file) return null;
      const path = `${folder}/${ts}_${name}.jpg`;
      const { error } = await client.storage.from('guest-id-documents').upload(path, file, { upsert:true });
      if(error) throw error;
      return path;
    }

    if(!isMinor){
      front_url = await upload(`${idType}_front`, front);
      if(back) back_url = await upload(`${idType}_back`, back);
      if(selfie) selfie_url = await upload(`selfie`, selfie);
    }

    // Upsert guest_documents with phone/email columns (per migration)
    const payload = {
      booking_id: S.reservation.booking_id,
      guest_type: isPrimary ? 'primary' : 'additional',
      guest_sequence: seq,
      guest_name: name,
      guest_age: age,
      guest_phone: phone,
      guest_email: email,
      document_type: idType,
      document_number: idNumber,
      document_front_url: front_url,
      document_back_url: back_url,
      selfie_url: selfie_url,
      status: isMinor ? 'verified' : 'pending', // minors auto‚Äëverified
      user_agent: navigator.userAgent
    };

    const { data: existing } = await client
      .from('guest_documents')
      .select('id')
      .eq('booking_id', S.reservation.booking_id)
      .eq('guest_sequence', seq)
      .maybeSingle();

    if(existing){ await client.from('guest_documents').update(payload).eq('id', existing.id); }
    else{ await client.from('guest_documents').insert(payload); }

    await loadDocs();
    show('scrDone');
  }catch(err){
    console.error(err);
    alert('Could not submit. Please try again.');
  }finally{ loadOff(); }
});

/* Buttons */
q('#btnCancelForm').addEventListener('click', ()=>{ showDashboard(); startPolling(); });
q('#btnBackDash').addEventListener('click', ()=>{ showDashboard(); startPolling(); });

q('#btnLogout').addEventListener('click', ()=>{
  stopPolling();
  if(S.approvalSubscription){
    S.approvalSubscription.unsubscribe();
    S.approvalSubscription = null;
  }
  localStorage.removeItem(SESSION_KEY);
  S.reservation=null; S.docs=[]; S.session=null; S.currentSeq=null; S.mealPrefs={};
  show('scrVerify');
});

q('#btnMeals').addEventListener('click', async ()=>{
  stopPolling();
  await loadMenuData();
  await renderMealSelection();
  show('scrMeals');
});

/* ---------- MEAL SELECTION RENDERING ---------- */
async function renderMealSelection(){
  if(!S.menuData){ await loadMenuData(); }
  
  const container = q('#mealsContainer');
  container.innerHTML = '';
  
  const mealTypes = ['breakfast', 'lunch', 'barbeque', 'dinner'];
  
  mealTypes.forEach(mealType => {
    const menu = S.menuData[mealType];
    if(!menu) return;
    
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <div class="h">
        <span>${getMealEmoji(mealType)}</span>
        <h2>${menu.title}</h2>
      </div>
      <p class="muted" style="margin-bottom:12px">${menu.rule}</p>
      <div id="meal_${mealType}" data-meal="${mealType}" class="mealOptions"></div>
    `;
    container.appendChild(card);
    
    renderMealOptions(mealType, menu);
  });
}

function getMealEmoji(mealType){
  const emojis = { breakfast: 'üåÖ', lunch: 'üçú', barbeque: 'üî•', dinner: 'üåô' };
  return emojis[mealType] || 'üçΩÔ∏è';
}

function renderMealOptions(mealType, menu){
  const box = q(`#meal_${mealType}`);
  box.innerHTML = '';
  
  // Breakfast: 1 Veg & 1 Non-veg OR 2 Veg
  if(mealType === 'breakfast'){
    renderCheckboxGroup(box, 'Veg Options', menu.veg, `${mealType}_veg`, 2);
    renderCheckboxGroup(box, 'Non-Veg Options', menu.nonVeg, `${mealType}_nonveg`, 1);
    renderCheckboxGroup(box, 'Accompaniments', menu.accompaniments, `${mealType}_acc`, 999);
  }
  // Lunch & Dinner: 1 from each
  else if(mealType === 'lunch' || mealType === 'dinner'){
    if(menu.vegMain) renderCheckboxGroup(box, 'Vegetarian', menu.vegMain, `${mealType}_veg`, 1);
    if(menu.dal) renderCheckboxGroup(box, 'Dal', menu.dal, `${mealType}_dal`, 1);
    if(menu.paneer && mealType === 'dinner') renderCheckboxGroup(box, 'Paneer', menu.paneer, `${mealType}_paneer`, 1);
    if(menu.nonVeg) renderCheckboxGroup(box, 'Non-Veg', menu.nonVeg, `${mealType}_nonveg`, 1);
    if(menu.accompaniments) renderCheckboxGroup(box, 'Accompaniments', menu.accompaniments, `${mealType}_acc`, 999);
  }
  // Barbeque: 2 Veg + 2 Non-veg
  else if(mealType === 'barbeque'){
    renderCheckboxGroup(box, 'Vegetarian (choose 2)', menu.veg, `${mealType}_veg`, 2);
    renderCheckboxGroup(box, 'Non-Veg (choose 2)', menu.nonVeg, `${mealType}_nonveg`, 2);
  }
}

function renderCheckboxGroup(container, label, options, groupId, maxSelect){
  if(!options || options.length === 0) return;
  
  const section = document.createElement('div');
  section.style.marginBottom = '12px';
  section.innerHTML = `<div class="muted" style="font-size:13px;margin-bottom:6px;font-weight:600">${label}</div>`;
  
  const optionsDiv = document.createElement('div');
  optionsDiv.style.display = 'grid';
  optionsDiv.style.gridTemplateColumns = '1fr 1fr';
  optionsDiv.style.gap = '8px';
  
  options.forEach(option => {
    const checkId = `${groupId}_${option.replace(/\\s+/g,'_').toLowerCase()}`;
    const label_el = document.createElement('label');
    label_el.style.display = 'flex';
    label_el.style.alignItems = 'center';
    label_el.style.gap = '8px';
    label_el.style.cursor = 'pointer';
    label_el.style.fontSize = '14px';
    label_el.style.fontWeight = '500';
    
    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.id = checkId;
    checkbox.value = option;
    checkbox.className = 'mealCheckbox';
    checkbox.setAttribute('data-group', groupId);
    checkbox.setAttribute('data-max', maxSelect);
    checkbox.style.width = '18px';
    checkbox.style.height = '18px';
    checkbox.style.cursor = 'pointer';
    
    checkbox.addEventListener('change', () => {
      const group = document.querySelectorAll(`input[data-group="${groupId}"]:checked`);
      if(group.length > maxSelect){
        checkbox.checked = false;
        alert(`Maximum ${maxSelect} selection(s) allowed for this section`);
      }
    });
    
    label_el.appendChild(checkbox);
    label_el.appendChild(document.createTextNode(option));
    optionsDiv.appendChild(label_el);
  });
  
  section.appendChild(optionsDiv);
  container.appendChild(section);
}

function collectMealSelections(){
  const selections = {};
  const mealTypes = ['breakfast', 'lunch', 'barbeque', 'dinner'];
  
  mealTypes.forEach(mealType => {
    const checked = Array.from(document.querySelectorAll(`input[data-group^="${mealType}"]:checked`))
      .map(cb => cb.value);
    if(checked.length > 0){
      selections[mealType] = checked;
    }
  });
  
  return selections;
}

/* ---------- MEAL SAVE HANDLERS ---------- */
q('#btnSaveMeals').addEventListener('click', async ()=>{
  const selections = collectMealSelections();
  
  if(Object.keys(selections).length === 0){
    alert('Please select at least one meal option');
    return;
  }
  
  const dietaryPref = q('#dietaryPref').value.trim();
  const specialReq = q('#specialReq').value.trim();
  
  loadOn('Saving meal selections...');
  try{
    const mealTypes = ['breakfast', 'lunch', 'barbeque', 'dinner'];
    
    for(const mealType of mealTypes){
      const selectedItems = selections[mealType] || [];
      
      if(selectedItems.length > 0){
        const payload = {
          booking_id: S.reservation.booking_id,
          guest_sequence: 1, // Primary guest only
          meal_type: mealType,
          selections: selectedItems,
          dietary_preferences: dietaryPref || null,
          special_requests: specialReq || null,
          submitted_at: new Date().toISOString()
        };
        
        // Upsert to guest_meal_preferences
        const { data: existing } = await client
          .from('guest_meal_preferences')
          .select('id')
          .eq('booking_id', S.reservation.booking_id)
          .eq('guest_sequence', 1)
          .eq('meal_type', mealType)
          .maybeSingle();
        
        if(existing){
          await client.from('guest_meal_preferences').update(payload).eq('id', existing.id);
        }else{
          await client.from('guest_meal_preferences').insert(payload);
        }
      }
    }
    
    await loadMealPrefs();
    alert('‚úÖ Meal selections saved successfully!');
    showDashboard();
    startPolling();
  }catch(err){
    console.error(err);
    alert('Could not save meals. Please try again.');
  }finally{ loadOff(); }
});

q('#btnCancelMeals').addEventListener('click', ()=>{
  showDashboard();
  startPolling();
});

/* ---------- RESTORE SESSION ---------- */
window.addEventListener('load', async ()=>{
  await loadMenuData();
  const ses = readSessionLocally();
  if(!ses) return;
  // Try to restore
  q('#bookingId').value = ses.booking_id;
  q('#phone').value = ses.phone;
  // Auto kick verification flow
  q('#formVerify').dispatchEvent(new Event('submit'));
});
</script>
</body>
</html>