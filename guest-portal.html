<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#1a73e8">
  <meta name="description" content="Hostizzy Guest Portal v2 ‚Äî secure KYC & meal selection after approval">
  <title>Hostizzy Guest Portal v2</title>

  <!-- PWA Manifest & Icons (optional) -->
  <link rel="manifest" href="guest-manifest.json">
  <link rel="icon" type="image/png" href="assets/logo-192.png">
  <link rel="apple-touch-icon" href="assets/logo-192.png">

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --primary:#1a73e8;
      --primary-dark:#1557b0;
      --primary-50:#e8f0fe;
      --primary-light:#6fa8dc;
      --success:#34a853;
      --success-light:#d4edda;
      --warning:#fbbc04;
      --warning-light:#fff3cd;
      --danger:#ea4335;
      --danger-light:#f8d7da;
      --ink:#202124;
      --ink-light:#5f6368;
      --muted:#5f6368;
      --border:#dadce0;
      --bg:#fff;
      --bg-2:#f8f9fa;
      --radius:14px;
      --radius-lg:16px;
      --shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);
      --shadow-md:0 2px 8px rgba(0,0,0,.15);
      --shadow-lg:0 8px 24px rgba(0,0,0,.18);
      --ease:all .25s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Ubuntu, sans-serif;
      background: linear-gradient(135deg, var(--bg-2) 0%, #f0f4f8 100%);
      color: var(--ink);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      min-height: 100vh;
    }
    
    .app {
      max-width: 640px;
      margin: 0 auto;
      min-height: 100vh;
      background: var(--bg);
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
    }
    
    header {
      position: sticky;
      top: 0;
      z-index: 10;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: #fff;
      padding: 20px;
      box-shadow: var(--shadow-lg);
    }
    
    header h1 {
      font-size: 22px;
      font-weight: 800;
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: center;
      letter-spacing: -0.5px;
    }
    
    header .sub {
      opacity: 0.92;
      font-size: 13px;
      text-align: center;
      margin-top: 6px;
      font-weight: 500;
      letter-spacing: 0.3px;
    }
    
    main {
      padding: 18px;
      flex: 1;
    }
    
    .screen {
      display: none;
      animation: fade .3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .screen.active {
      display: block;
    }
    
    @keyframes fade {
      from {
        opacity: 0;
        transform: translateY(8px);
      }
      to {
        opacity: 1;
        transform: none;
      }
    }
    
    .card {
      background: var(--bg);
      border-radius: var(--radius-lg);
      padding: 18px;
      margin-bottom: 16px;
      box-shadow: var(--shadow-md);
      border: 1px solid rgba(0,0,0,0.04);
      transition: box-shadow 0.3s ease;
    }
    
    .card:hover {
      box-shadow: var(--shadow-lg);
    }
    
    .card.premium {
      background: linear-gradient(135deg, rgba(26, 115, 232, 0.05) 0%, rgba(52, 168, 83, 0.05) 100%);
      border: 1px solid var(--primary-50);
    }
    
    .card .h {
      display: flex;
      gap: 12px;
      align-items: center;
      border-bottom: 2px solid var(--bg-2);
      padding-bottom: 12px;
      margin-bottom: 16px;
    }
    
    .card .h span {
      font-size: 24px;
    }
    
    .card .h h2 {
      font-size: 16px;
      font-weight: 700;
      color: var(--ink);
    }
    
    .muted {
      color: var(--muted);
      font-size: 14px;
      line-height: 1.5;
    }
    
    label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--ink);
      letter-spacing: 0.3px;
    }
    
    input, select {
      width: 100%;
      border: 2px solid var(--border);
      border-radius: 10px;
      padding: 13px 14px;
      font-size: 16px;
      transition: var(--ease);
      background: var(--bg);
      font-family: inherit;
    }
    
    input:hover {
      border-color: #c5cad1;
    }
    
    input:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px var(--primary-50);
    }
    
    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }
    
    .payment-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid var(--bg-2);
      font-size: 14px;
    }
    
    .payment-row:last-child {
      border-bottom: none;
    }
    
    .payment-row.total {
      padding: 14px 0;
      border-top: 2px solid var(--primary-50);
      border-bottom: none;
      font-weight: 700;
      font-size: 16px;
      color: var(--primary);
      margin-top: 8px;
    }
    
    .payment-label {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    
    .payment-label .label-main {
      color: var(--ink);
      font-weight: 500;
    }
    
    .payment-label .label-sub {
      font-size: 12px;
      color: var(--muted);
    }
    
    .payment-value {
      text-align: right;
      font-weight: 600;
      color: var(--ink);
    }
    
    .btn {
      display: inline-flex;
      gap: 8px;
      align-items: center;
      justify-content: center;
      border: none;
      border-radius: 10px;
      padding: 13px 18px;
      font-weight: 700;
      font-size: 16px;
      cursor: pointer;
      transition: all .2s cubic-bezier(0.4, 0, 0.2, 1);
      font-family: inherit;
    }
    
    .btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .btn:active:not(:disabled) {
      transform: translateY(0);
    }
    
    .btn.primary {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: #fff;
    }
    
    .btn.secondary {
      background: var(--bg-2);
      color: var(--ink);
      border: 2px solid var(--border);
    }
    
    .btn.secondary:hover:not(:disabled) {
      background: #efefef;
      border-color: var(--muted);
    }
    
    .btn.success {
      background: linear-gradient(135deg, var(--success) 0%, #2d7a3e 100%);
      color: #fff;
    }
    
    .btn.block {
      width: 100%;
    }
    
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    .badge {
      display: inline-block;
      padding: 5px 12px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .b-pending {
      background: var(--warning-light);
      color: #856404;
    }
    
    .b-verified {
      background: var(--success-light);
      color: #155724;
    }
    
    .b-rejected {
      background: var(--danger-light);
      color: #721c24;
    }
    
    .b-incomplete {
      background: #e2e3e5;
      color: #383d41;
    }
    
    .pulse {
      animation: pulse 2s ease-in-out infinite;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    
    .list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .item {
      background: var(--bg-2);
      border-radius: 12px;
      padding: 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      border: 2px solid transparent;
      transition: var(--ease);
    }
    
    .item:hover {
      border-color: var(--primary);
      background: #fff;
      box-shadow: var(--shadow);
    }
    
    .status {
      margin-left: 10px;
    }
    
    .progress {
      height: 8px;
      background: var(--bg-2);
      border-radius: 6px;
      overflow: hidden;
      margin: 12px 0;
      box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
    }
    
    .fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary) 0%, var(--success) 100%);
      width: 0;
      transition: width .4s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 0 10px rgba(26, 115, 232, 0.4);
    }
    
    .center {
      text-align: center;
    }
    
    .help {
      background: var(--primary-50);
      color: var(--primary-dark);
      border-left: 4px solid var(--primary);
      padding: 12px 14px;
      border-radius: 10px;
      margin: 12px 0;
      font-size: 14px;
      line-height: 1.6;
    }
    
    .warn {
      background: var(--warning-light);
      color: #7f5f01;
      border-left: 4px solid var(--warning);
      padding: 12px 14px;
      border-radius: 10px;
      margin: 12px 0;
      font-size: 14px;
      line-height: 1.6;
    }
    
    .success {
      background: var(--success-light);
      color: #155724;
      border-left: 4px solid var(--success);
      padding: 12px 14px;
      border-radius: 10px;
      margin: 12px 0;
      font-size: 14px;
      line-height: 1.6;
    }
    
    .error {
      background: var(--danger-light);
      color: #721c24;
      border-left: 4px solid var(--danger);
      padding: 12px 14px;
      border-radius: 10px;
      margin: 12px 0;
      font-size: 14px;
      line-height: 1.6;
    }
    
    .toolbar {
      display: flex;
      gap: 12px;
      margin-top: 14px;
      flex-direction: column;
    }
    
    .toolbar .btn {
      width: 100%;
    }
    
    .top-progress {
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 12px;
      font-weight: 600;
      letter-spacing: 0.3px;
    }
    
    .hidden {
      display: none !important;
    }
    
    footer {
      padding: 20px;
      text-align: center;
      color: var(--muted);
      font-size: 13px;
      border-top: 1px solid var(--border);
      margin-top: auto;
      font-weight: 500;
    }
    
    @media (max-width: 480px) {
      main { padding: 14px; }
      .row { grid-template-columns: 1fr; }
      header h1 { font-size: 20px; }
      .card { padding: 16px; }
    }
    
    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(400px);
        opacity: 0;
      }
    }
    
    .toast-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-width: 400px;
    }
    
    .toast {
      background: white;
      padding: 16px;
      border-radius: 10px;
      box-shadow: var(--shadow-lg);
      display: flex;
      gap: 12px;
      align-items: center;
      animation: slideIn 0.3s ease;
      min-width: 300px;
      border-left: 4px solid;
    }
    
    .toast.success { border-left-color: var(--success); }
    .toast.error { border-left-color: var(--danger); }
    .toast.info { border-left-color: var(--primary); }
    .toast.warning { border-left-color: var(--warning); }
    
    .toggle-btn {
      padding: 8px 12px;
      border: 2px solid var(--border);
      background: white;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: inherit;
    }
    
    .toggle-btn:hover {
      border-color: var(--primary);
      background: var(--primary-50);
    }
  </style>
</head>
<body>
<div id="toastContainer" class="toast-container"></div>
<div class="app">
  <header>
    <h1>üè† Hostizzy Guest Portal</h1>
    <div class="sub">Secure KYC ‚Ä¢ Real‚Äëtime Status ‚Ä¢ Meal Selection</div>
  </header>

  <main>
    <!-- SCREEN 1: VERIFY (Booking Code + Phone) -->
    <section id="scrVerify" class="screen active">
      <div class="card">
        <div class="h"><span>üîê</span><h2>Verify your booking</h2></div>
        <p class="muted">Use your booking code and phone number. The link is universal ‚Äî no details in the URL.</p>
        <form id="formVerify">
          <label for="bookingId">Booking Code</label>
          <input id="bookingId" placeholder="e.g., HZ-AB12CD" required autocomplete="off">
          <label for="phone" style="margin-top:14px">Phone Number</label>
          <input id="phone" type="tel" inputmode="numeric" pattern="[0-9]{10}" placeholder="10-digit mobile" required autocomplete="tel">
          <div class="toolbar">
            <button class="btn primary block" type="submit">Continue ‚Üí</button>
          </div>
        </form>
      </div>
      <div class="help">Having trouble? Reach out to your Hostizzy coordinator with your booking code.</div>
    </section>

    <!-- SCREEN 2: ENTER GUEST NAMES (Primary only) -->
    <section id="scrNames" class="screen">
      <div class="card">
        <div class="h"><span>üìù</span><h2>Enter all guest names</h2></div>
        <p class="muted">Add names for every adult guest. You can edit later if needed.</p>
        <div id="namesContainer" class="list"></div>
        <div class="toolbar">
          <button id="btnSaveNames" class="btn primary block">Save & Continue</button>
        </div>
      </div>
    </section>

    <!-- SCREEN 3: DASHBOARD -->
    <section id="scrDash" class="screen">
      <div class="card premium">
        <div class="h"><span>üè°</span><h2 id="propTitle">Reservation</h2></div>
        <div class="row">
          <div>
            <label>Check‚Äëin</label>
            <div id="ci" class="muted" style="font-weight:600;color:var(--ink);">‚Äî</div>
          </div>
          <div>
            <label>Check‚Äëout</label>
            <div id="co" class="muted" style="font-weight:600;color:var(--ink);">‚Äî</div>
          </div>
          <div>
            <label>Nights</label>
            <div id="nights" class="muted" style="font-weight:600;color:var(--ink);">‚Äî</div>
          </div>
          <div>
            <label>Guests</label>
            <div id="guests" class="muted" style="font-weight:600;color:var(--ink);">‚Äî</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="h"><span>üí∞</span><h2>Payment Summary</h2></div>
        <div id="paymentBreakdown"></div>
        <div id="paymentStatus" style="margin-top:14px;font-weight:700;"></div>
      </div>

      <div class="card">
        <div class="h"><span>üìÑ</span><h2>Guest KYC</h2></div>
        <div class="top-progress" id="topStepText">Guest 1/1 ‚Äî Step 1/4</div>
        <div class="progress"><div id="bar" class="fill" style="width:0%"></div></div>
        <div id="listGuests" class="list"></div>
        <div class="warn">Data is auto‚Äëdeleted 60 days after check‚Äëout. Phone & email are used only for operational updates.</div>
        <div class="toolbar">
          <button id="btnLogout" class="btn secondary block">Logout</button>
        </div>
      </div>

       <div class="card hidden" id="mealsCard">
        <div class="h"><span>üçΩÔ∏è</span><h2>Meal Selection</h2></div>
        <div class="success">All guests are verified. You can now select meals for your group.</div>
        <button id="btnMeals" class="btn success block" style="margin-top:12px;">Proceed to Meal Selection ‚Üí</button>
      </div>

      <div class="card hidden" id="mealsDisplayCard">
        <div class="h"><span>üçΩÔ∏è</span><h2>Selected Meals</h2></div>
        <div id="mealsDisplayContent"></div>
        <div id="mealsStatus" class="muted" style="margin-top:12px;font-weight:600"></div>
        <div class="toolbar" style="margin-top:14px">
          <button id="btnRequestMealChanges" class="btn secondary block">Request Changes</button>
        </div>
      </div>
    </section>

    <!-- SCREEN 5: MEAL SELECTION (Primary guest only) -->
    <section id="scrMeals" class="screen">
      <!-- Guest Count Header -->
      <div class="card premium" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border:none;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div>
            <div style="font-size: 13px; opacity: 0.9; font-weight:500;">Booking Details</div>
            <div style="font-size: 18px; font-weight: 700; margin-top: 6px;" id="guestCountDisplay">üë• Loading...</div>
            <div style="font-size: 12px; opacity: 0.85; margin-top: 6px;" id="datesDisplay">üìÖ Loading...</div>
          </div>
          <div style="font-size: 48px;">üè°</div>
        </div>
      </div>

      <div class="card">
        <div class="h"><span>üçΩÔ∏è</span><h2>Select Meals</h2></div>
        <p class="muted">As primary guest, select meals for all guests. Dietary preferences & special requests are optional.</p>
      </div>

      <div id="mealsContainer" class="list"></div>

      <div class="card">
        <!-- Dietary Preferences Section -->
        <div style="margin-bottom: 16px;">
          <label style="display: flex; gap: 8px; align-items: center; margin-bottom: 12px;">
            <span>ü•ó Dietary Preferences (Optional)</span>
          </label>
          <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px;" id="dietaryOptionsContainer">
            <!-- Dynamic buttons will be added here -->
          </div>
          <input id="dietaryPref" placeholder="Or enter custom dietary preference..." style="margin-top: 8px;">
          <div id="dietarySelected" style="font-size: 12px; color: var(--muted); margin-top: 6px;"></div>
        </div>

        <!-- Special Requests Section -->
        <div style="margin-bottom: 14px; padding-top: 12px; border-top: 1px solid var(--border);">
          <label style="display: flex; gap: 8px; align-items: center; margin-bottom: 12px;">
            <span>‚≠ê Special Requests (Optional)</span>
          </label>
          <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px;" id="requestsOptionsContainer">
            <!-- Dynamic buttons will be added here -->
          </div>
          <input id="specialReq" placeholder="Or enter custom special request..." style="margin-top: 8px;">
          <div id="requestsSelected" style="font-size: 12px; color: var(--muted); margin-top: 6px;"></div>
        </div>

        <div class="toolbar" style="margin-top:16px">
          <button id="btnSaveMeals" class="btn success block">Save Meal Selections</button>
          <button id="btnCancelMeals" class="btn secondary block">Back to Dashboard</button>
        </div>
      </div>
    </section>

    <!-- SCREEN 4: GUEST FORM (Primary: selfie required; Additional: no selfie) -->
    <section id="scrForm" class="screen">
      <div class="card">
        <div class="h"><span>üë§</span><h2 id="formTitle">Guest Information</h2></div>
        <div id="stepText" class="top-progress">Guest 1/1 ‚Äî Step 2/4</div>
        <form id="formGuest">
          <label for="gName">Full name (as per ID)</label>
          <input id="gName" required placeholder="Enter full name">

          <div class="row" style="margin-top:14px">
            <div>
              <label for="gAge">Age</label>
              <input id="gAge" type="number" min="1" max="120" required placeholder="18">
            </div>
            <div>
              <label for="gEmail">Email</label>
              <input id="gEmail" type="email" required placeholder="name@email.com">
            </div>
          </div>

          <label for="gPhone" style="margin-top:14px">Phone</label>
          <input id="gPhone" type="tel" inputmode="numeric" pattern="[0-9]{10}" required placeholder="10-digit mobile">

          <div id="idBlock">
            <label style="margin-top:14px">ID Type</label>
            <select id="idType" required>
              <option value="" disabled selected>Select one</option>
              <option value="aadhar">Aadhar Card</option>
              <option value="passport">Passport</option>
              <option value="driving_license">Driver's License</option>
              <option value="voter_id">Voter ID</option>
            </select>

            <label for="idNumber" style="margin-top:14px">ID Number</label>
            <input id="idNumber" placeholder="Enter ID number">

            <div style="margin-top:14px">
              <label>Document ‚Äî Front</label>
              <input id="fileFront" type="file" accept="image/*" capture="environment" required>
            </div>
            <div id="backWrap" style="margin-top:14px">
              <label>Document ‚Äî Back</label>
              <input id="fileBack" type="file" accept="image/*" capture="environment">
            </div>
            <div id="selfieWrap" style="margin-top:14px">
              <label>Live Selfie (primary guest only)</label>
              <input id="fileSelfie" type="file" accept="image/*" capture="user">
            </div>
          </div>

          <div class="toolbar" style="margin-top:16px">
            <button id="btnCancelForm" type="button" class="btn secondary">Cancel</button>
            <button class="btn primary" type="submit">Save & Submit</button>
          </div>
        </form>
      </div>
    </section>

    <!-- SUCCESS MINI -->
    <section id="scrDone" class="screen">
      <div class="card center">
        <div style="font-size:64px;margin-bottom:12px;animation:bounce 0.6s ease">‚úÖ</div>
        <h2>Submission successful</h2>
        <p class="muted" style="margin-top:8px">We'll review and update the status shortly.</p>
        <div class="success" style="margin-top:14px">You'll also get an email when verification is completed.</div>
        <button id="btnBackDash" class="btn primary block" style="margin-top:16px">Back to Dashboard</button>
      </div>
    </section>
  </main>

  <footer>¬© 2025 Hostizzy. All rights reserved.</footer>
</div>

<!-- Loading overlay -->
<div id="overlay" style="position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:9999;">
  <div style="text-align:center;color:#fff">
    <div style="width:54px;height:54px;border-radius:50%;border:4px solid rgba(255,255,255,.35);border-top-color:#fff;animation:spin 1s linear infinite;margin:0 auto"></div>
    <div id="ovText" style="margin-top:10px;font-weight:600">Loading...</div>
  </div>
</div>

<style>
  @keyframes spin { to { transform: rotate(360deg); } }
  @keyframes bounce { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
</style>

<script>
/* ========================================
   CONFIGURATION & CONSTANTS
   ======================================== */
const CONFIG = {
  SUPABASE_URL: 'https://dxthxsguqrxpurorpokq.supabase.co',
  SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR4dGh4c2d1cXJ4cHVyb3Jwb2txIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwMjc4MTMsImV4cCI6MjA3NTYwMzgxM30.JhGzqUolA-A_fGha-0DhHVl7p1vRq4CZcp5ttdVxjQg',
  SESSION_KEY: 'hz_guest_session_v2',
  POLL_INTERVAL: 5000,
  SESSION_TIMEOUT: 24 * 60 * 60 * 1000,
  MENU_PATH: './menu-template-standard.json',
  STORAGE_BUCKET: 'guest-id-documents',
  DIETARY_OPTIONS: ['Vegetarian', 'Non-Veg', 'Jain', 'Vegan', 'Gluten-Free'],
  SPECIAL_REQUESTS: ['Spicy', 'No Spice', 'Extra Oil', 'No Onion', 'No Garlic'],
  ID_NEEDS_BACK: ['aadhar', 'driving_license', 'voter_id']
};

const client = window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);

/* ========================================
   DOM HELPER UTILITIES
   ======================================== */
const DOM = {
  q: (sel) => document.querySelector(sel),
  qa: (sel) => document.querySelectorAll(sel),
  
  show: (id) => {
    DOM.qa('.screen').forEach(s => s.classList.remove('active'));
    DOM.q('#' + id).classList.add('active');
  },
  
  hide: (id) => DOM.q('#' + id).classList.add('hidden'),
  
  toggle: (id, condition) => {
    DOM.q('#' + id).classList.toggle('hidden', !condition);
  },
  
  loadOn: (msg = 'Loading...') => {
    DOM.q('#ovText').textContent = msg;
    DOM.q('#overlay').style.display = 'flex';
  },
  
  loadOff: () => {
    DOM.q('#overlay').style.display = 'none';
  },
  
  setVal: (id, val) => {
    const el = DOM.q('#' + id);
    if (el) el.value = val;
  },
  
  getVal: (id) => {
    const el = DOM.q('#' + id);
    return el ? el.value.trim() : '';
  },
  
  setText: (id, txt) => {
    const el = DOM.q('#' + id);
    if (el) el.textContent = txt;
  },
  
  setHTML: (id, html) => {
    const el = DOM.q('#' + id);
    if (el) el.innerHTML = html;
  }
};

const q = DOM.q;
const show = DOM.show;
const loadOn = DOM.loadOn;
const loadOff = DOM.loadOff;

/* ========================================
   VALIDATION UTILITIES
   ======================================== */
const VALIDATORS = {
  phone: (ph) => /^[0-9]{10}$/.test(ph.replace(/\D/g, '')),
  
  email: (em) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(em),
  
  age: (ag) => !isNaN(ag) && ag >= 1 && ag <= 120,
  
  isSessionValid: (data) => data && Date.now() <= (data.expiresAt || 0)
};

/* ========================================
   UTILITY FUNCTIONS
   ======================================== */
const Utils = {
  fmtDate: (d) => new Date(d).toLocaleDateString('en-IN', {
    day: 'numeric', month: 'short', year: 'numeric'
  }),
  
  fmtCurrency: (amt) => {
    return `‚Çπ${parseFloat(amt || 0).toLocaleString('en-IN', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
  },
  
  calcNights: (checkIn, checkOut) => {
    if (!checkIn || !checkOut) return 0;
    return Math.ceil((new Date(checkOut) - new Date(checkIn)) / (1000 * 60 * 60 * 24));
  },
  
  getMealEmoji: (mealType) => {
    const emojis = { breakfast: 'üåÖ', lunch: 'üçú', barbeque: 'üî•', dinner: 'üåô' };
    return emojis[mealType] || 'üçΩÔ∏è';
  },
  
  randToken: () => {
    return crypto.getRandomValues(new Uint8Array(16))
      .reduce((a, b) => a + ('0' + b.toString(16)).slice(-2), '');
  },
  
  showNotification: (msg, type = 'success', duration = 3000) => {
    const notif = document.createElement('div');
    notif.className = `toast ${type}`;
    notif.textContent = msg;
    DOM.q('#toastContainer').appendChild(notif);
    setTimeout(() => notif.remove(), duration);
  }
};

/* ========================================
   DATABASE SERVICE LAYER
   ======================================== */
const DB = {
  getReservation: async (bookingId) => {
    try {
      const { data, error } = await client
        .from('reservations')
        .select('*')
        .eq('booking_id', bookingId)
        .single();
      
      if (error || !data) throw new Error('Booking not found');
      if (data.status === 'cancelled') throw new Error('Reservation cancelled');
      return data;
    } catch (err) {
      throw new Error(err.message || 'Failed to fetch reservation');
    }
  },
  
  createSession: async (bookingId, phoneVerified) => {
    try {
      const token = Utils.randToken();
      await client.from('guest_portal_sessions').insert({
        booking_id: bookingId,
        guest_sequence: null,
        phone_verified: phoneVerified,
        verified_at: new Date().toISOString(),
        session_token: token
      });
      
      return { token, booking_id: bookingId };
    } catch (err) {
      console.error('Session creation note:', err);
      return { token: Utils.randToken(), booking_id: bookingId };
    }
  },
  
  getGuestDocs: async (bookingId) => {
    try {
      const { data, error } = await client
        .from('guest_documents')
        .select('*')
        .eq('booking_id', bookingId)
        .order('guest_sequence', { ascending: true });
      
      if (error) throw error;
      return data || [];
    } catch (err) {
      console.error('Failed to fetch guest docs:', err);
      return [];
    }
  },
  
  saveGuestName: async (bookingId, seq, name, isPrimary) => {
    try {
      const { data: existing } = await client
        .from('guest_documents')
        .select('id')
        .eq('booking_id', bookingId)
        .eq('guest_sequence', seq)
        .maybeSingle();
      
      const payload = {
        booking_id: bookingId,
        guest_type: isPrimary ? 'primary' : 'additional',
        guest_sequence: seq,
        guest_name: name,
        status: 'incomplete'
      };
      
      if (existing) {
        await client.from('guest_documents').update(payload).eq('id', existing.id);
      } else {
        await client.from('guest_documents').insert(payload);
      }
    } catch (err) {
      throw new Error(err.message || 'Failed to save guest name');
    }
  },
  
  saveMealPreferences: async (bookingId, meals, dietary, specialReq) => {
    try {
      const { data: existing } = await client
        .from('guest_meal_preferences')
        .select('id')
        .eq('booking_id', bookingId)
        .eq('guest_sequence', 1)
        .maybeSingle();
      
      const payload = {
        booking_id: bookingId,
        guest_sequence: 1,
        meals: meals,
        dietary_preferences: dietary || null,
        special_requests: specialReq || null,
        submitted_at: new Date().toISOString()
      };
      
      if (existing) {
        payload.status = 'pending';
        payload.approved_by = null;
        payload.approved_at = null;
        payload.rejected_reason = null;
        await client.from('guest_meal_preferences').update(payload).eq('id', existing.id);
      } else {
        await client.from('guest_meal_preferences').insert(payload);
      }
    } catch (err) {
      throw new Error(err.message || 'Failed to save meal preferences');
    }
  },
  
  getMealPreferences: async (bookingId) => {
    try {
      const { data, error } = await client
        .from('guest_meal_preferences')
        .select('*')
        .eq('booking_id', bookingId)
        .maybeSingle();
      
      if (!error && data) {
        return {
          combined: data,
          status: data.status || 'pending',
          meals: data.meals || {},
          dietary_preferences: data.dietary_preferences,
          special_requests: data.special_requests,
          approved_by: data.approved_by,
          approved_at: data.approved_at,
          rejected_reason: data.rejected_reason
        };
      }
      return null;
    } catch (err) {
      console.error('Failed to fetch meal preferences:', err);
      return null;
    }
  },
  
  uploadFile: async (folder, filename, file) => {
    try {
      const path = `${folder}/${Date.now()}_${filename}.jpg`;
      const { error, data } = await client.storage
        .from(CONFIG.STORAGE_BUCKET)
        .upload(path, file, { upsert: true });
      
      if (error) throw new Error(`Upload failed: ${error.message}`);
      return path;
    } catch (err) {
      throw new Error(err.message || 'File upload failed');
    }
  },
  
  saveGuestDocument: async (booking_id, payload) => {
    try {
      const { data: existing } = await client
        .from('guest_documents')
        .select('id')
        .eq('booking_id', booking_id)
        .eq('guest_sequence', payload.guest_sequence)
        .maybeSingle();
      
      if (existing) {
        await client.from('guest_documents').update(payload).eq('id', existing.id);
      } else {
        await client.from('guest_documents').insert(payload);
      }
    } catch (err) {
      throw new Error(err.message || 'Failed to save guest document');
    }
  }
};

/* ========================================
   UI HELPER FUNCTIONS
   ======================================== */
const UI = {
  createToggleButtons: (options, containerId, onToggle, activeColor = 'var(--primary)') => {
    const container = DOM.q('#' + containerId);
    if (!container) return () => [];
    
    const selected = [];
    
    options.forEach(option => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.textContent = option;
      btn.className = 'toggle-btn';
      
      btn.onclick = (e) => {
        e.preventDefault();
        const isSelected = selected.includes(option);
        if (isSelected) {
          selected.splice(selected.indexOf(option), 1);
          btn.style.background = 'white';
          btn.style.color = 'var(--ink)';
          btn.style.borderColor = 'var(--border)';
        } else {
          selected.push(option);
          btn.style.background = activeColor;
          btn.style.color = 'white';
          btn.style.borderColor = activeColor;
        }
        onToggle(selected);
      };
      
      container.appendChild(btn);
    });
    
    return () => selected;
  },
  
  showApprovalNotification: (guestName, propertyName) => {
    const notif = document.createElement('div');
    notif.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, var(--success) 0%, #2d7a3e 100%);
      color: white;
      padding: 16px 20px;
      border-radius: 12px;
      box-shadow: var(--shadow-lg);
      z-index: 10000;
      font-weight: 600;
      animation: slideIn 0.3s ease;
    `;
    notif.textContent = `‚úÖ ${guestName}'s KYC approved for ${propertyName}`;
    document.body.appendChild(notif);
    
    setTimeout(() => {
      notif.style.animation = 'slideOut 0.3s ease';
      setTimeout(() => notif.remove(), 300);
    }, 4000);
  },
  
  renderPaymentBreakdown: (reservation) => {
    const breakdownDiv = DOM.q('#paymentBreakdown');
    if (!breakdownDiv) return;
    
    const total = parseFloat(reservation.total_amount || 0);
    const paid = parseFloat(reservation.paid_amount || 0);
    const balance = Math.max(0, total - paid);
    const stayCharges = parseFloat(reservation.stay_amount || 0);
    const mealCharges = parseFloat(reservation.meals_chef || 0);
    const taxes = parseFloat(reservation.taxes || 0);
    
    // Summary cards layout
    let html = `
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px;">
        <div style="background:linear-gradient(135deg, var(--primary-50) 0%, #e8f0fe 100%);border-radius:12px;padding:14px;border:1px solid var(--primary-50);">
          <div style="font-size:12px;color:var(--muted);font-weight:600;margin-bottom:4px;">Total Amount</div>
          <div style="font-size:20px;font-weight:800;color:var(--primary);">${Utils.fmtCurrency(total)}</div>
        </div>
        <div style="background:linear-gradient(135deg, ${paid > 0 ? 'var(--success-light)' : '#f5f5f5'} 0%, ${paid > 0 ? '#e6f4ea' : '#f5f5f5'} 100%);border-radius:12px;padding:14px;border:1px solid ${paid > 0 ? 'var(--success-light)' : 'var(--border)'};">
          <div style="font-size:12px;color:var(--muted);font-weight:600;margin-bottom:4px;">Paid Amount</div>
          <div style="font-size:20px;font-weight:800;color:${paid > 0 ? 'var(--success)' : 'var(--muted)'};">${Utils.fmtCurrency(paid)}</div>
        </div>
      </div>
    `;
    
    // Breakdown section
    html += `<div style="margin-bottom:12px;">`;
    
    if (stayCharges > 0) {
      html += `
        <div class="payment-row">
          <div class="payment-label">
            <div class="label-main">üè† Stay Charges</div>
            <div class="label-sub">${reservation.nights || 1} night${(reservation.nights || 1) > 1 ? 's' : ''}</div>
          </div>
          <div class="payment-value">${Utils.fmtCurrency(stayCharges)}</div>
        </div>
      `;
    }
    
    if (mealCharges > 0) {
      html += `
        <div class="payment-row">
          <div class="payment-label">
            <div class="label-main">üçΩÔ∏è Meal Charges</div>
            <div class="label-sub">${reservation.adults || 1} guest${(reservation.adults || 1) > 1 ? 's' : ''}</div>
          </div>
          <div class="payment-value">${Utils.fmtCurrency(mealCharges)}</div>
        </div>
      `;
    }
    
    if (taxes > 0) {
      html += `
        <div class="payment-row">
          <div class="payment-label">
            <div class="label-main">üìä Taxes & Fees</div>
          </div>
          <div class="payment-value">${Utils.fmtCurrency(taxes)}</div>
        </div>
      `;
    }
    
    html += `</div>`;
    
    // Balance section with color coding
    const balanceColor = balance > 0 ? 'var(--warning)' : 'var(--success)';
    const balanceGradient = balance > 0 ? 'var(--warning-light)' : 'var(--success-light)';
    
    html += `
      <div style="background:linear-gradient(135deg, ${balanceGradient} 0%, #fff 100%);border-radius:12px;padding:14px;border:2px solid ${balanceColor};margin-top:12px;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div>
            <div style="font-size:12px;color:var(--muted);font-weight:600;margin-bottom:4px;">Balance Due</div>
            <div style="font-size:24px;font-weight:800;color:${balanceColor};">${balance > 0 ? Utils.fmtCurrency(balance) : '‚úÖ Fully Paid'}</div>
          </div>
          <div style="font-size:48px;">${balance > 0 ? '‚è≥' : '‚úÖ'}</div>
        </div>
      </div>
    `;
    
    DOM.setHTML('paymentBreakdown', html);
    
    // Payment status badge
    const payStatus = reservation.payment_status || 'pending';
    const statusBadge = 
      payStatus === 'paid' ? '<span style="background:var(--success-light);color:#155724;padding:8px 16px;border-radius:20px;font-weight:700;font-size:13px;display:inline-block;margin-top:12px;">‚úÖ Fully Paid</span>' :
      payStatus === 'partial' ? '<span style="background:var(--warning-light);color:#7f5f01;padding:8px 16px;border-radius:20px;font-weight:700;font-size:13px;display:inline-block;margin-top:12px;">‚è≥ Partial Payment</span>' :
      '<span style="background:#e2e3e5;color:#383d41;padding:8px 16px;border-radius:20px;font-weight:700;font-size:13px;display:inline-block;margin-top:12px;">‚è≥ Pending Payment</span>';
    
    DOM.setHTML('paymentStatus', statusBadge);
  }
};

/* ========================================
   APP STATE
   ======================================== */
const S = {
  reservation: null,
  isPrimary: false,
  session: null,
  docs: [],
  mealPrefs: {},
  pollTimer: null,
  currentSeq: null,
  totalAdults: 0,
  menuData: null,
  approvalSubscription: null
};

/* ========================================
   SESSION MANAGEMENT
   ======================================== */
function saveSessionLocally(obj) {
  const payload = { ...obj, expiresAt: Date.now() + CONFIG.SESSION_TIMEOUT };
  localStorage.setItem(CONFIG.SESSION_KEY, JSON.stringify(payload));
}

function readSessionLocally() {
  const raw = localStorage.getItem(CONFIG.SESSION_KEY);
  if (!raw) return null;
  
  const data = JSON.parse(raw);
  if (!VALIDATORS.isSessionValid(data)) {
    localStorage.removeItem(CONFIG.SESSION_KEY);
    return null;
  }
  return data;
}

/* ========================================
   MENU DATA LOADING
   ======================================== */
async function loadMenuData() {
  try {
    const res = await fetch(CONFIG.MENU_PATH);
    if (!res.ok) throw new Error('Menu load failed: ' + res.statusText);
    S.menuData = await res.json();
  } catch (e) {
    console.error('Menu load failed:', e);
    Utils.showNotification('Failed to load menu data', 'error');
  }
}

/* ========================================
   VERIFICATION & ONBOARDING
   ======================================== */
DOM.q('#formVerify').addEventListener('submit', async (e) => {
  e.preventDefault();
  const booking_id = DOM.getVal('bookingId').toUpperCase();
  const phone = DOM.getVal('phone');

  if (!VALIDATORS.phone(phone)) {
    alert('Enter a valid 10-digit phone number');
    return;
  }

  loadOn('Verifying booking...');
  try {
    const rsv = await DB.getReservation(booking_id);
    
    S.reservation = rsv;
    S.totalAdults = rsv.adults || 1;
    S.isPrimary = phone.replace(/\D/g, '').slice(-10) === 
                  (rsv.guest_phone || '').replace(/\D/g, '').slice(-10);

    await DB.createSession(booking_id, true);
    
    S.session = { booking_id, phone };
    saveSessionLocally(S.session);

    await ensureNameRowsOrCollect();

  } catch (err) {
    console.error(err);
    alert(err.message || 'Verification failed');
  } finally {
    loadOff();
  }
});

async function ensureNameRowsOrCollect() {
  await loadDocs();

  const haveRows = S.docs.length > 0;
  const namesMissing = S.docs.length < S.totalAdults || S.docs.some(d => !d.guest_name);

  if (S.isPrimary && (!haveRows || namesMissing)) {
    renderNamesInputs();
    show('scrNames');
  } else {
    await showDashboard();
  }
}

function renderNamesInputs() {
  const box = DOM.q('#namesContainer');
  box.innerHTML = '';
  const count = Math.max(S.totalAdults, S.docs.length || 0);
  
  for (let i = 1; i <= count; i++) {
    const existing = S.docs.find(d => d.guest_sequence === i);
    const val = existing?.guest_name || (i === 1 ? S.reservation.guest_name : `Guest ${i}`);
    const row = document.createElement('div');
    row.className = 'item';
    row.innerHTML = `
      <div style="flex:1">
        <div class="muted">Guest ${i}${i === 1 ? ' (Primary)' : ''}</div>
        <input data-seq="${i}" class="nameInput" style="margin-top:8px" value="${val}">
      </div>`;
    box.appendChild(row);
  }
}

DOM.q('#btnSaveNames').addEventListener('click', async () => {
  loadOn('Saving names...');
  try {
    const inputs = Array.from(document.querySelectorAll('.nameInput'));
    for (const inp of inputs) {
      const seq = parseInt(inp.getAttribute('data-seq'));
      const name = inp.value.trim();
      if (!name) continue;
      await DB.saveGuestName(S.reservation.booking_id, seq, name, seq === 1);
    }

    await loadDocs();
    await showDashboard();
  } catch (e) {
    console.error(e);
    alert('Could not save names.');
  } finally {
    loadOff();
  }
});

/* ========================================
   DOCUMENT & POLLING
   ======================================== */
async function loadDocs() {
  S.docs = await DB.getGuestDocs(S.reservation.booking_id);
}

function updateGuestCountDisplay() {
  if (S.reservation) {
    const adults = S.reservation.adults || 0;
    const kids = S.reservation.kids || 0;
    const total = adults + kids;
    
    const checkIn = S.reservation.check_in 
      ? new Date(S.reservation.check_in).toLocaleDateString('en-IN', { year: 'numeric', month: 'short', day: 'numeric' })
      : 'TBD';
    const checkOut = S.reservation.check_out 
      ? new Date(S.reservation.check_out).toLocaleDateString('en-IN', { year: 'numeric', month: 'short', day: 'numeric' })
      : 'TBD';
    
    const nightsCount = Utils.calcNights(S.reservation.check_in, S.reservation.check_out);
    
    DOM.setText('guestCountDisplay', `üë• ${total} Guest${total !== 1 ? 's' : ''} (${adults}A, ${kids}K)`);
    DOM.setText('datesDisplay', `üìÖ ${checkIn} to ${checkOut} ‚Ä¢ ${nightsCount} Night${nightsCount !== 1 ? 's' : ''}`);
  }
}

async function setupApprovalListener() {
  const subscription = client
    .channel(`doc_changes_${S.reservation.booking_id}`)
    .on(
      'postgres_changes',
      {
        event: 'UPDATE',
        schema: 'public',
        table: 'guest_documents',
        filter: `booking_id=eq.${S.reservation.booking_id}`
      },
      async (payload) => {
        const newData = payload.new;
        const oldData = payload.old;
        
        if (oldData?.status !== 'verified' && newData?.status === 'verified') {
          await loadDocs();
          renderDashGuests();
          updateDashProgress();
          maybeShowMeals();
          UI.showApprovalNotification(newData.guest_name, S.reservation.property_name);
        }
      }
    )
    .subscribe();
  
  S.approvalSubscription = subscription;
}

function startPolling() {
  stopPolling();
  S.pollTimer = setInterval(async () => {
    const onDash = DOM.q('#scrDash').classList.contains('active');
    if (!onDash) return;
    
    await loadDocs();
    await loadMealPrefs();
    renderDashGuests();
    updateDashProgress();
    maybeShowMeals();
  }, CONFIG.POLL_INTERVAL);
}

function stopPolling() {
  if (S.pollTimer) {
    clearInterval(S.pollTimer);
    S.pollTimer = null;
  }
}

/* ========================================
   DASHBOARD
   ======================================== */
async function loadMealPrefs() {
  S.mealPrefs = await DB.getMealPreferences(S.reservation.booking_id) || {};
}

async function showDashboard() {
  const r = S.reservation;
  DOM.setText('propTitle', r.property_name || 'Reservation');
  DOM.setText('ci', Utils.fmtDate(r.check_in));
  DOM.setText('co', Utils.fmtDate(r.check_out));
  DOM.setText('nights', (r.nights || 1) + ' night' + ((r.nights || 1) > 1 ? 's' : ''));
  DOM.setText('guests', `${r.adults || 1} adults${r.kids ? `, ${r.kids} kids` : ''}`);

  UI.renderPaymentBreakdown(r);

  renderDashGuests();
  updateDashProgress();
  maybeShowMeals();
  await loadMealPrefs();
  displayMealsOnDashboard();

  show('scrDash');
  await setupApprovalListener();
  startPolling();
}

async function displayMealsOnDashboard() {
  const card = DOM.q('#mealsDisplayCard');
  const content = DOM.q('#mealsDisplayContent');
  const status = DOM.q('#mealsStatus');
  
  if (!S.mealPrefs || !S.mealPrefs.meals || Object.keys(S.mealPrefs.meals).length === 0) {
    card.classList.add('hidden');
    return;
  }
  
  card.classList.remove('hidden');
  content.innerHTML = '';
  
  const mealTypes = ['breakfast', 'lunch', 'barbeque', 'dinner'];
  let displayedCount = 0;
  const mealStatus = S.mealPrefs.status || 'saved';
  
  mealTypes.forEach(mealType => {
    const meals = S.mealPrefs.meals[mealType];
    
    if (meals && meals.length > 0) {
      displayedCount++;
      
      const section = document.createElement('div');
      section.style.cssText = `
        margin-bottom: 12px;
        padding: 12px;
        background-color: var(--bg-2);
        border-radius: 8px;
        border-left: 4px solid var(--primary);
      `;
      
      const title = document.createElement('div');
      title.style.cssText = `
        font-weight: 700;
        margin-bottom: 6px;
        font-size: 15px;
      `;
      title.textContent = `${Utils.getMealEmoji(mealType)} ${mealType.charAt(0).toUpperCase() + mealType.slice(1)}`;
      section.appendChild(title);
      
      const selections = document.createElement('div');
      selections.style.cssText = `
        font-size: 14px;
        color: var(--ink);
        line-height: 1.6;
      `;
      selections.innerHTML = meals.map(s => `<span style="display: inline-block; margin-right: 6px; margin-bottom: 4px;">‚Ä¢ ${s}</span>`).join('');
      section.appendChild(selections);
      
      content.appendChild(section);
    }
  });
  
  if (S.mealPrefs.dietary_preferences) {
    const dietarySection = document.createElement('div');
    dietarySection.style.cssText = `
      margin-top: 12px;
      padding: 12px;
      background-color: var(--primary-50);
      border-radius: 8px;
      border-left: 4px solid var(--primary);
    `;
    
    const dietaryTitle = document.createElement('div');
    dietaryTitle.style.cssText = `
      font-weight: 600;
      margin-bottom: 4px;
    `;
    dietaryTitle.textContent = 'ü•ó Dietary Preferences';
    dietarySection.appendChild(dietaryTitle);
    
    const dietaryText = document.createElement('div');
    dietaryText.style.cssText = `
      font-size: 14px;
      color: var(--ink);
    `;
    dietaryText.textContent = S.mealPrefs.dietary_preferences;
    dietarySection.appendChild(dietaryText);
    
    content.appendChild(dietarySection);
  }
  
  if (S.mealPrefs.special_requests) {
    const specialSection = document.createElement('div');
    specialSection.style.cssText = `
      margin-top: 8px;
      padding: 12px;
      background-color: var(--warning-light);
      border-radius: 8px;
      border-left: 4px solid var(--warning);
    `;
    
    const specialTitle = document.createElement('div');
    specialTitle.style.cssText = `
      font-weight: 600;
      margin-bottom: 4px;
    `;
    specialTitle.textContent = '‚≠ê Special Requests';
    specialSection.appendChild(specialTitle);
    
    const specialText = document.createElement('div');
    specialText.style.cssText = `
      font-size: 14px;
      color: #7f5f01;
    `;
    specialText.textContent = S.mealPrefs.special_requests;
    specialSection.appendChild(specialText);
    
    content.appendChild(specialSection);
  }
  
  if (displayedCount === 0) {
    card.classList.add('hidden');
  } else {
    const statusBadgeStyle = {
      'pending': 'background: var(--warning-light); color: #7f5f01;',
      'approved': 'background: var(--success-light); color: #155724;',
      'rejected': 'background: var(--danger-light); color: #721c24;',
      'saved': 'background: #e2e3e5; color: #383d41;'
    }[mealStatus] || 'background: #e2e3e5; color: #383d41;';
    
    const statusText = mealStatus === 'pending' ? '‚è≥ Pending Approval' : 
                       mealStatus === 'approved' ? '‚úÖ Approved' : 
                       mealStatus === 'rejected' ? '‚ùå Rejected - Action Needed' : 'üíæ Saved';
    
    status.style.cssText = `
      ${statusBadgeStyle}
      padding: 8px 12px;
      border-radius: 20px;
      font-weight: 700;
      font-size: 13px;
      display: inline-block;
    `;
    status.textContent = statusText;
    
    DOM.q('#btnRequestMealChanges').style.display = mealStatus === 'approved' ? 'none' : 'block';
  }
}

function renderDashGuests() {
  const list = DOM.q('#listGuests');
  list.innerHTML = '';
  const total = S.totalAdults || Math.max(1, S.docs.length);
  
  for (let i = 1; i <= total; i++) {
    const doc = S.docs.find(d => d.guest_sequence === i);
    const name = doc?.guest_name || (i === 1 ? (S.reservation.guest_name || 'Primary Guest') : `Guest ${i}`);
    const status = doc?.status || 'incomplete';

    const badge = 
      status === 'verified' ? '<span class="badge b-verified">Verified</span>' :
      status === 'pending' ? '<span class="badge b-pending pulse">Pending</span>' :
      status === 'rejected' ? '<span class="badge b-rejected">Rejected</span>' :
      '<span class="badge b-incomplete">Incomplete</span>';

    const item = document.createElement('div');
    item.className = 'item';
    item.innerHTML = `
      <div>
        <div style="font-weight:700">${name}${i === 1 ? ' (Primary)' : ''}</div>
        <div class="muted">Guest ${i}</div>
      </div>
      <div class="status">${badge}</div>`;

    item.addEventListener('click', () => openGuestForm(i));
    list.appendChild(item);
  }
}

function updateDashProgress() {
  const total = Math.max(S.totalAdults, S.docs.length || 0) || 1;
  const verified = (S.docs || []).filter(d => d.status === 'verified').length;
  DOM.q('#bar').style.width = `${(verified / total) * 100}%`;
  DOM.setText('topStepText', `Guest ${Math.min((S.currentSeq || 1), total)}/${total} ‚Äî Step ${S.isPrimary ? 2 : 2}/4`);
}

function maybeShowMeals() {
  const total = Math.max(S.totalAdults, S.docs.length || 0) || 1;
  const verified = (S.docs || []).filter(d => d.status === 'verified').length;
  DOM.toggle('mealsCard', verified >= total);
}

/* ========================================
   GUEST FORM
   ======================================== */
function openGuestForm(seq) {
  stopPolling();
  S.currentSeq = seq;
  const isPrimary = seq === 1;
  const doc = S.docs.find(d => d.guest_sequence === seq);

  DOM.setText('formTitle', isPrimary ? 'Primary Guest ‚Äî KYC' : `Guest ${seq} ‚Äî KYC`);
  DOM.setText('stepText', `Guest ${seq}/${Math.max(S.totalAdults, S.docs.length || 0) || 1} ‚Äî Step 2/4`);

  DOM.setVal('gName', doc?.guest_name || (isPrimary ? (S.reservation.guest_name || '') : `Guest ${seq}`));
  DOM.setVal('gAge', doc?.guest_age || '');
  DOM.setVal('gEmail', doc?.guest_email || (isPrimary ? (S.reservation.guest_email || '') : ''));
  DOM.setVal('gPhone', doc?.guest_phone || (isPrimary ? (S.reservation.guest_phone || '') : ''));
  DOM.setVal('idType', doc?.document_type || '');
  DOM.setVal('idNumber', doc?.document_number || '');

  DOM.q('#selfieWrap').style.display = isPrimary ? 'block' : 'none';

  const needsBack = CONFIG.ID_NEEDS_BACK.includes(DOM.getVal('idType'));
  DOM.q('#backWrap').style.display = needsBack ? 'block' : 'none';

  show('scrForm');
}

DOM.q('#idType').addEventListener('change', () => {
  const v = DOM.getVal('idType');
  DOM.q('#backWrap').style.display = CONFIG.ID_NEEDS_BACK.includes(v) ? 'block' : 'none';
});

DOM.q('#formGuest').addEventListener('submit', async (e) => {
  e.preventDefault();

  const name = DOM.getVal('gName');
  const age = parseInt(DOM.getVal('gAge'), 10);
  const email = DOM.getVal('gEmail');
  const phone = DOM.getVal('gPhone');

  if (!name) { alert('Enter full name'); return; }
  if (!VALIDATORS.email(email)) { alert('Enter a valid email'); return; }
  if (!VALIDATORS.phone(phone)) { alert('Enter a valid 10-digit phone'); return; }

  const isMinor = age < 18;
  const seq = S.currentSeq;
  const isPrimary = seq === 1;

  let idType = null, idNumber = null, front = null, back = null, selfie = null;
  if (!isMinor) {
    idType = DOM.getVal('idType');
    idNumber = DOM.getVal('idNumber');
    if (!idType) { alert('Select an ID type'); return; }
    if (!DOM.q('#fileFront').files[0]) { alert('Upload front side of the ID'); return; }
    
    const needBack = CONFIG.ID_NEEDS_BACK.includes(idType);
    if (needBack && !DOM.q('#fileBack').files[0]) { alert('Upload back side of the ID'); return; }
    if (isPrimary && !DOM.q('#fileSelfie').files[0]) { alert('Primary guest must add a selfie'); return; }

    front = DOM.q('#fileFront').files[0];
    back = DOM.q('#fileBack').files[0] || null;
    selfie = DOM.q('#fileSelfie').files[0] || null;
  }

  loadOn('Uploading documents...');

  try {
    let front_url = null, back_url = null, selfie_url = null;
    const folder = `${S.reservation.booking_id}/guest_${seq}_${name.replace(/\s+/g, '_').toLowerCase()}`;

    const upload = async (filename, file) => {
      if (!file) return null;
      return await DB.uploadFile(folder, filename, file);
    };

    if (!isMinor) {
      front_url = await upload(`${idType}_front`, front);
      if (back) back_url = await upload(`${idType}_back`, back);
      if (selfie) selfie_url = await upload(`selfie`, selfie);
    }

    const payload = {
      booking_id: S.reservation.booking_id,
      guest_type: isPrimary ? 'primary' : 'additional',
      guest_sequence: seq,
      guest_name: name,
      guest_age: age,
      guest_phone: phone,
      guest_email: email,
      document_type: idType,
      document_number: idNumber,
      document_front_url: front_url,
      document_back_url: back_url,
      selfie_url: selfie_url,
      status: isMinor ? 'verified' : 'pending',
      user_agent: navigator.userAgent
    };

    await DB.saveGuestDocument(S.reservation.booking_id, payload);
    await loadDocs();
    show('scrDone');
  } catch (err) {
    console.error(err);
    alert(err.message || 'Could not submit. Please try again.');
  } finally {
    loadOff();
  }
});

/* ========================================
   BUTTON HANDLERS
   ======================================== */
DOM.q('#btnCancelForm').addEventListener('click', () => {
  showDashboard();
  startPolling();
});

DOM.q('#btnBackDash').addEventListener('click', () => {
  showDashboard();
  startPolling();
});

DOM.q('#btnRequestMealChanges').addEventListener('click', async () => {
  const confirmed = confirm('Edit your meal preferences?');
  if (!confirmed) return;
  
  S.mealPrefs = {};
  await renderMealSelection();
  updateGuestCountDisplay();
  initializeDietaryAndRequestsUI();
  show('scrMeals');
  window.scrollTo(0, 0);
  Utils.showNotification('Edit your selections and save again.', 'info');
});

DOM.q('#btnLogout').addEventListener('click', () => {
  const confirmed = confirm('Are you sure you want to logout? You\'ll need to verify again.');
  if (!confirmed) return;
  
  stopPolling();
  if (S.approvalSubscription) {
    S.approvalSubscription.unsubscribe();
    S.approvalSubscription = null;
  }
  localStorage.removeItem(CONFIG.SESSION_KEY);
  S.reservation = null;
  S.docs = [];
  S.session = null;
  S.currentSeq = null;
  S.mealPrefs = {};
  show('scrVerify');
  Utils.showNotification('Logged out successfully', 'success');
});

DOM.q('#btnMeals').addEventListener('click', async () => {
  stopPolling();
  await loadMenuData();
  await renderMealSelection();
  updateGuestCountDisplay();
  initializeDietaryAndRequestsUI();
  show('scrMeals');
});

/* ========================================
   MEAL SELECTION
   ======================================== */
function initializeDietaryAndRequestsUI() {
  UI.createToggleButtons(
    CONFIG.DIETARY_OPTIONS,
    'dietaryOptionsContainer',
    (selected) => {
      DOM.setText('dietarySelected', 
        selected.length ? `‚úÖ Selected: ${selected.join(', ')}` : '');
      DOM.setVal('dietaryPref', selected.join(', '));
    }
  );
  
  UI.createToggleButtons(
    CONFIG.SPECIAL_REQUESTS,
    'requestsOptionsContainer',
    (selected) => {
      DOM.setText('requestsSelected',
        selected.length ? `‚úÖ Selected: ${selected.join(', ')}` : '');
      DOM.setVal('specialReq', selected.join(', '));
    },
    'var(--warning)'
  );
}

async function renderMealSelection() {
  if (!S.menuData) await loadMenuData();
  
  const container = DOM.q('#mealsContainer');
  container.innerHTML = '';
  
  const mealTypes = ['breakfast', 'lunch', 'barbeque', 'dinner'];
  
  mealTypes.forEach(mealType => {
    const menu = S.menuData[mealType];
    if (!menu) return;
    
    const card = document.createElement('div');
    card.className = 'card';
    card.style.cssText = `
      border-left: 5px solid var(--primary);
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.02) 0%, rgba(236, 72, 153, 0.02) 100%);
    `;
    card.innerHTML = `
      <div class="h" style="border-bottom: 2px solid var(--primary); padding-bottom: 12px;">
        <span style="font-size: 28px;">${Utils.getMealEmoji(mealType)}</span>
        <div>
          <h2>${menu.title}</h2>
          <div class="muted" style="font-size: 12px; margin-top: 2px;">${menu.rule}</div>
        </div>
      </div>
      <div id="meal_${mealType}" data-meal="${mealType}" class="mealOptions" style="margin-top: 12px;"></div>
    `;
    container.appendChild(card);
    
    renderMealOptions(mealType, menu);
  });
}

function renderMealOptions(mealType, menu) {
  const box = DOM.q(`#meal_${mealType}`);
  box.innerHTML = '';
  
  if (mealType === 'breakfast') {
    renderCheckboxGroup(box, 'Veg Options', menu.veg, `${mealType}_veg`, 2);
    renderCheckboxGroup(box, 'Non-Veg Options', menu.nonVeg, `${mealType}_nonveg`, 1);
    renderCheckboxGroup(box, 'Accompaniments', menu.accompaniments, `${mealType}_acc`, 999);
  } else if (mealType === 'lunch' || mealType === 'dinner') {
    if (menu.vegMain) renderCheckboxGroup(box, 'Vegetarian', menu.vegMain, `${mealType}_veg`, 1);
    if (menu.dal) renderCheckboxGroup(box, 'Dal', menu.dal, `${mealType}_dal`, 1);
    if (menu.paneer && mealType === 'dinner') renderCheckboxGroup(box, 'Paneer', menu.paneer, `${mealType}_paneer`, 1);
    if (menu.nonVeg) renderCheckboxGroup(box, 'Non-Veg', menu.nonVeg, `${mealType}_nonveg`, 1);
    if (menu.accompaniments) renderCheckboxGroup(box, 'Accompaniments', menu.accompaniments, `${mealType}_acc`, 999);
  } else if (mealType === 'barbeque') {
    renderCheckboxGroup(box, 'Vegetarian (choose 2)', menu.veg, `${mealType}_veg`, 2);
    renderCheckboxGroup(box, 'Non-Veg (choose 2)', menu.nonVeg, `${mealType}_nonveg`, 2);
  }
}

function renderCheckboxGroup(container, label, options, groupId, maxSelect) {
  if (!options || options.length === 0) return;
  
  const section = document.createElement('div');
  section.style.marginBottom = '12px';
  section.innerHTML = `<div class="muted" style="font-size:13px;margin-bottom:8px;font-weight:600">${label}</div>`;
  
  const optionsDiv = document.createElement('div');
  optionsDiv.style.display = 'grid';
  optionsDiv.style.gridTemplateColumns = '1fr 1fr';
  optionsDiv.style.gap = '8px';
  
  options.forEach(option => {
    const checkId = `${groupId}_${option.replace(/\s+/g, '_').toLowerCase()}`;
    const label_el = document.createElement('label');
    label_el.style.cssText = `
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
    `;
    
    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.id = checkId;
    checkbox.value = option;
    checkbox.className = 'mealCheckbox';
    checkbox.setAttribute('data-group', groupId);
    checkbox.setAttribute('data-max', maxSelect);
    checkbox.style.cssText = `
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: var(--primary);
    `;
    
    checkbox.addEventListener('change', () => {
      const group = document.querySelectorAll(`input[data-group="${groupId}"]:checked`);
      if (group.length > maxSelect) {
        checkbox.checked = false;
        alert(`Maximum ${maxSelect} selection(s) allowed for this section`);
      }
    });
    
    label_el.appendChild(checkbox);
    label_el.appendChild(document.createTextNode(option));
    optionsDiv.appendChild(label_el);
  });
  
  section.appendChild(optionsDiv);
  container.appendChild(section);
}

function collectMealSelections() {
  const selections = {};
  const mealTypes = ['breakfast', 'lunch', 'barbeque', 'dinner'];
  
  mealTypes.forEach(mealType => {
    const checked = Array.from(document.querySelectorAll(`input[data-group^="${mealType}"]:checked`))
      .map(cb => cb.value);
    if (checked.length > 0) {
      selections[mealType] = checked;
    }
  });
  
  return selections;
}

DOM.q('#btnSaveMeals').addEventListener('click', async () => {
  const selections = collectMealSelections();
  
  if (Object.keys(selections).length === 0) {
    alert('Please select at least one meal option');
    return;
  }
  
  const dietaryPref = DOM.getVal('dietaryPref');
  const specialReq = DOM.getVal('specialReq');
  
  loadOn('Saving meal selections...');
  try {
    await DB.saveMealPreferences(
      S.reservation.booking_id,
      selections,
      dietaryPref,
      specialReq
    );
    
    await loadMealPrefs();
    lockMealSelections();
    Utils.showNotification('‚úÖ Meals saved successfully!', 'success');
    await showDashboard();
    startPolling();

  } catch (err) {
    console.error(err);
    alert(err.message || 'Could not save meals.');
  } finally {
    loadOff();
  }
});

function lockMealSelections() {
  document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
    cb.disabled = true;
  });
  DOM.q('#btnSaveMeals').disabled = true;
  DOM.q('#btnSaveMeals').style.opacity = '0.6';
}

DOM.q('#btnCancelMeals').addEventListener('click', () => {
  showDashboard();
  startPolling();
});

/* ========================================
   INITIALIZATION
   ======================================== */
window.addEventListener('load', async () => {
  await loadMenuData();
  const ses = readSessionLocally();
  if (!ses) return;
  
  DOM.setVal('bookingId', ses.booking_id);
  DOM.setVal('phone', ses.phone);
  DOM.q('#formVerify').dispatchEvent(new Event('submit'));
});
</script>
</body>
</html>
